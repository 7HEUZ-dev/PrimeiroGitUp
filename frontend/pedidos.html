<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pedidos â€¢ PÃ£oQuentinho</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <style>
    .shell{display:grid;grid-template-columns:280px 1fr;min-height:100vh;background:#fffdf9}
    .sidebar{border-right:1px solid #e5e7eb;background:#fff;padding:16px}
    .side-brand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .menu{display:flex;flex-direction:column;gap:6px}
    .menu a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:#374151;text-decoration:none}
    .menu a.active{background:#fff1e6;color:#111827}
    .menu a .icon{width:28px;height:28px;border-radius:8px;background:#fff1e6;display:grid;place-items:center;color:#ea580c}
    .view{padding:18px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px}
    .pedido{background:#fffdf7;border:1px solid #f1f5f9;border-radius:12px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;gap:12px}
    .pedido .info{flex:1}
    .pedido .actions{display:flex;gap:8px}
    .filters{display:flex;gap:8px;margin:10px 0 12px}
  </style>
</head>
<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="side-brand">
        <div class="brand-icon">ğŸ</div>
        <div class="brand-name">PÃ£oQuentinho</div>
      </div>
      <div class="menu">
        <a href="./dono.html"><span class="icon">ğŸ </span>Dashboard</a>
        <a href="./pedidos.html" class="active"><span class="icon">ğŸ§¾</span>Pedidos</a>
        <a href="./produtos.html"><span class="icon">ğŸ“¦</span>Produtos</a>
        <a href="./clientes.html"><span class="icon">ğŸ‘¥</span>Clientes</a>
        <a href="./entregas.html"><span class="icon">ğŸšš</span>Entregas</a>
        <a href="./promocoes.html"><span class="icon">ğŸ·ï¸</span>PromoÃ§Ãµes</a>
        <a href="./relatorios.html"><span class="icon">ğŸ“Š</span>RelatÃ³rios</a>
        <a href="./avaliacoes.html"><span class="icon">ğŸ’¬</span>AvaliaÃ§Ãµes</a>
        <a href="./config.html"><span class="icon">âš™ï¸</span>ConfiguraÃ§Ãµes</a>
        <a href="./index.html" class="btn btn-white" style="margin-top:8px">Ver loja</a>
      </div>
    </aside>
    <main class="view">
      <div class="topbar">
        <div>
          <div class="section-sub" id="padariaNome">Padaria</div>
          <div class="section-title" style="text-align:left">Pedidos</div>
        </div>
        <div class="brand-icon">JP</div>
      </div>
      <div class="panel">
        <div class="filters">
          <button class="btn btn-white" data-status="todos">Todos</button>
          <button class="btn btn-white" data-status="pendente">Em aberto</button>
          <button class="btn btn-white" data-status="em_preparacao">Em preparaÃ§Ã£o</button>
          <button class="btn btn-white" data-status="a_caminho">Saiu para entrega</button>
          <button class="btn btn-white" data-status="entregue">ConcluÃ­do</button>
          <button class="btn btn-white" data-status="cancelado">Cancelado</button>
        </div>
        <div id="listaPedidos"></div>
      </div>
    </main>
  </div>
  <script>
    const token = localStorage.getItem('token');
    const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
    const donoId = usuario?.id;
    let padariaId = usuario?.padariaId;
    const auth = token ? { 'Authorization': 'Bearer ' + token } : {};
    async function getPadaria() {
      if (padariaId) return padariaId;
      if (!donoId) return null;
      const r = await fetch('http://localhost:4000/padarias/dono/' + donoId);
      const p = await r.json();
      padariaId = p?.id;
      return padariaId;
    }
    function formatBRL(n){ return 'R$ ' + (Number(n||0)).toFixed(2).replace('.', ','); }
    async function carregar(status='todos'){
      const pid = await getPadaria();
      if(!pid) return;
      const padariaResp = await fetch('http://localhost:4000/padarias/' + pid);
      const padaria = await padariaResp.json();
      document.getElementById('padariaNome').textContent = padaria?.nome || 'Padaria';
      const pedidosResp = await fetch('http://localhost:4000/pedidos/padaria/' + pid, { headers: auth });
      const pedidos = await pedidosResp.json();
      const alvo = document.getElementById('listaPedidos');
      const filtro = status==='todos' ? pedidos : pedidos.filter(p=>p.status===status);
      alvo.innerHTML = filtro.map(p => `
        <div class="pedido">
          <div class="info">
            <div><strong>#${p.id}</strong> â€¢ ${p.cliente?.nome ?? 'Cliente'}</div>
            <div>${p.itens.map(i => `${i.quantidade}x ${i.produto?.nome}`).join(', ')}</div>
            <div>${formatBRL(p.valorTotal)} â€¢ ${p.enderecoEntrega}</div>
          </div>
          <div class="actions">
            ${p.status==='pendente' ? `<button class="btn btn-primary" onclick="atualizarStatus(${p.id}, 'em_preparacao')">Aceitar</button>
            <button class="btn btn-white" onclick="recusar(${p.id})">Recusar</button>` : ''}
            ${p.status==='em_preparacao' ? `<button class="btn btn-primary" onclick="atualizarStatus(${p.id}, 'a_caminho')">Saiu para entrega</button>` : ''}
            ${p.status==='a_caminho' ? `<button class="btn btn-primary" onclick="atualizarStatus(${p.id}, 'entregue')">Concluir</button>` : ''}
          </div>
        </div>
      `).join('');
    }
    async function atualizarStatus(id, status){
      await fetch('http://localhost:4000/pedidos/' + id + '/status', {
        method:'PATCH',
        headers: { 'Content-Type':'application/json', ...auth },
        body: JSON.stringify({ status })
      });
      carregar('todos');
    }
    async function recusar(id){
      const motivo = prompt('Motivo da recusa');
      await atualizarStatus(id, 'cancelado');
      alert('Pedido #' + id + ' recusado: ' + (motivo || ''));
    }
    document.querySelectorAll('.filters .btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const status = btn.getAttribute('data-status') || 'todos';
        carregar(status);
      });
    });
    carregar('todos');
    setInterval(()=>carregar('todos'), 10000);
  </script>
</body>
</html>
