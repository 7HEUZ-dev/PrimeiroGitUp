<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Produtos ‚Ä¢ P√£oQuentinho</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <style>
    .shell{display:grid;grid-template-columns:280px 1fr;min-height:100vh;background:#fffdf9}
    .sidebar{border-right:1px solid #e5e7eb;background:#fff;padding:16px}
    .side-brand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .menu{display:flex;flex-direction:column;gap:6px}
    .menu a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:#374151;text-decoration:none}
    .menu a.active{background:#fff1e6;color:#111827}
    .menu a .icon{width:28px;height:28px;border-radius:8px;background:#fff1e6;display:grid;place-items:center;color:#ea580c}
    .view{padding:18px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px dashed #eee;padding:10px;text-align:left}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;align-items:center;justify-content:center}
    .modal .content{background:#fff;border-radius:16px;padding:16px;max-width:520px;width:100%;border:1px solid #e5e7eb}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field input{height:40px;border:1px solid #e5e7eb;border-radius:10px;padding:0 12px}
  </style>
</head>
<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="side-brand">
        <div class="brand-icon">üçû</div>
        <div class="brand-name">P√£oQuentinho</div>
      </div>
      <div class="menu">
        <a href="./dono.html"><span class="icon">üè†</span>Dashboard</a>
        <a href="./pedidos.html"><span class="icon">üßæ</span>Pedidos</a>
        <a href="./produtos.html" class="active"><span class="icon">üì¶</span>Produtos</a>
        <a href="./clientes.html"><span class="icon">üë•</span>Clientes</a>
        <a href="./entregas.html"><span class="icon">üöö</span>Entregas</a>
        <a href="./promocoes.html"><span class="icon">üè∑Ô∏è</span>Promo√ß√µes</a>
        <a href="./relatorios.html"><span class="icon">üìä</span>Relat√≥rios</a>
        <a href="./avaliacoes.html"><span class="icon">üí¨</span>Avalia√ß√µes</a>
        <a href="./config.html"><span class="icon">‚öôÔ∏è</span>Configura√ß√µes</a>
        <a href="./index.html" class="btn btn-white" style="margin-top:8px">Ver loja</a>
      </div>
    </aside>
    <main class="view">
      <div class="topbar">
        <div>
          <div class="section-sub" id="padariaNome">Padaria</div>
          <div class="section-title" style="text-align:left">Produtos</div>
        </div>
        <div class="brand-icon">JP</div>
      </div>
      <div class="panel">
        <table class="table">
          <thead>
            <tr>
              <th>Produto</th><th>Pre√ßo</th><th>Estoque</th><th>Categoria</th><th>Dispon√≠vel</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaProdutos"></tbody>
        </table>
        <div style="margin-top:12px">
          <button class="btn btn-primary" id="abrirModalProduto">Adicionar produto</button>
        </div>
      </div>
    </main>
  </div>
  <div id="modalProduto" class="modal">
    <div class="content">
      <h3>Novo produto</h3>
      <form id="formProduto">
        <div class="field"><label>Nome</label><input id="pNome" required></div>
        <div class="field"><label>Pre√ßo</label><input id="pPreco" type="number" step="0.01" required></div>
        <div class="field"><label>Estoque</label><input id="pEstoque" type="number" required></div>
        <div class="field"><label>Categoria</label><input id="pCategoria"></div>
        <div class="field"><label>Descri√ß√£o</label><input id="pDescricao"></div>
        <div class="actions"><button class="btn btn-primary" type="submit">Salvar</button><button class="btn btn-white" type="button" id="fecharModalProduto">Cancelar</button></div>
      </form>
    </div>
  </div>
  <script>
    const token = localStorage.getItem('token');
    const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
    const donoId = usuario?.id;
    let padariaId = usuario?.padariaId;
    const auth = token ? { 'Authorization': 'Bearer ' + token } : {};
    async function getPadaria() {
      if (padariaId) return padariaId;
      if (!donoId) return null;
      const r = await fetch('http://localhost:4000/padarias/dono/' + donoId);
      const p = await r.json();
      padariaId = p?.id;
      return padariaId;
    }
    function formatBRL(n){ return 'R$ ' + (Number(n||0)).toFixed(2).replace('.', ','); }
    async function carregar(){
      const pid = await getPadaria();
      if(!pid) return;
      const padariaResp = await fetch('http://localhost:4000/padarias/' + pid);
      const padaria = await padariaResp.json();
      document.getElementById('padariaNome').textContent = padaria?.nome || 'Padaria';
      const produtosResp = await fetch('http://localhost:4000/produtos/padaria/' + pid);
      const produtos = await produtosResp.json();
      const tbody = document.getElementById('tabelaProdutos');
      tbody.innerHTML = produtos.map(p => `
        <tr>
          <td>${p.nome}</td>
          <td>${formatBRL(p.preco)}</td>
          <td>${p.estoque ?? 0}</td>
          <td>${p.categoria ?? '-'}</td>
          <td>${p.disponivel ? 'Sim' : 'N√£o'}</td>
          <td>
            <button class="btn btn-white" onclick="toggleDisponivel(${p.id}, ${p.disponivel ? 'false':'true'})">${p.disponivel?'Pausar':'Retomar'}</button>
            <button class="btn btn-white" onclick="editarProduto(${p.id})">Editar</button>
          </td>
        </tr>
      `).join('');
    }
    async function toggleDisponivel(id, novo){
      await fetch('http://localhost:4000/produtos/disponivel/' + id, {
        method:'PATCH',
        headers:{ 'Content-Type':'application/json', ...auth },
        body: JSON.stringify({ disponivel: novo })
      });
      carregar();
    }
    async function editarProduto(id){
      const preco = prompt('Novo pre√ßo (usar ponto):');
      const estoque = prompt('Novo estoque (n√∫mero inteiro):');
      const categoria = prompt('Categoria (ex: P√£es, Doces, Bebidas):');
      const body = {};
      if(preco) body.preco = Number(preco);
      if(estoque) body.estoque = Number(estoque);
      if(categoria) body.categoria = categoria;
      if(Object.keys(body).length===0){ return; }
      await fetch('http://localhost:4000/produtos/' + id, {
        method:'PATCH',
        headers:{ 'Content-Type':'application/json', ...auth },
        body: JSON.stringify(body)
      });
      carregar();
    }
    const modal = document.getElementById('modalProduto');
    document.getElementById('abrirModalProduto').onclick = ()=> modal.style.display='flex';
    document.getElementById('fecharModalProduto').onclick = ()=> modal.style.display='none';
    document.getElementById('formProduto').onsubmit = async (e)=>{
      e.preventDefault();
      const body = {
        nome: document.getElementById('pNome').value,
        preco: Number(document.getElementById('pPreco').value),
        estoque: Number(document.getElementById('pEstoque').value),
        descricao: document.getElementById('pDescricao').value || undefined,
        categoria: document.getElementById('pCategoria').value || undefined
      };
      const res = await fetch('http://localhost:4000/produtos', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...auth },
        body: JSON.stringify(body)
      });
      if(res.ok){ alert('Produto criado'); modal.style.display='none'; carregar(); }
      else{ alert('Falha ao criar produto'); }
    };
    carregar();
    setInterval(carregar, 10000);
  </script>
</body>
</html>
