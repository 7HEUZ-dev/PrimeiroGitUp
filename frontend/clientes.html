<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clientes â€¢ PÃ£oQuentinho</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <style>
    .shell{display:grid;grid-template-columns:280px 1fr;min-height:100vh;background:#fffdf9}
    .sidebar{border-right:1px solid #e5e7eb;background:#fff;padding:16px}
    .side-brand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .menu{display:flex;flex-direction:column;gap:6px}
    .menu a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:#374151;text-decoration:none}
    .menu a.active{background:#fff1e6;color:#111827}
    .menu a .icon{width:28px;height:28px;border-radius:8px;background:#fff1e6;display:grid;place-items:center;color:#ea580c}
    .view{padding:18px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px}
    .rank{list-style:none;margin:0;padding:0}
    .rank li{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
  </style>
</head>
<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="side-brand">
        <div class="brand-icon">ğŸ</div>
        <div class="brand-name">PÃ£oQuentinho</div>
      </div>
      <div class="menu">
        <a href="./dono.html"><span class="icon">ğŸ </span>Dashboard</a>
        <a href="./pedidos.html"><span class="icon">ğŸ§¾</span>Pedidos</a>
        <a href="./produtos.html"><span class="icon">ğŸ“¦</span>Produtos</a>
        <a href="./clientes.html" class="active"><span class="icon">ğŸ‘¥</span>Clientes</a>
        <a href="./entregas.html"><span class="icon">ğŸšš</span>Entregas</a>
        <a href="./promocoes.html"><span class="icon">ğŸ·ï¸</span>PromoÃ§Ãµes</a>
        <a href="./relatorios.html"><span class="icon">ğŸ“Š</span>RelatÃ³rios</a>
        <a href="./avaliacoes.html"><span class="icon">ğŸ’¬</span>AvaliaÃ§Ãµes</a>
        <a href="./config.html"><span class="icon">âš™ï¸</span>ConfiguraÃ§Ãµes</a>
        <a href="./index.html" class="btn btn-white" style="margin-top:8px">Ver loja</a>
      </div>
    </aside>
    <main class="view">
      <div class="topbar">
        <div>
          <div class="section-sub" id="padariaNome">Padaria</div>
          <div class="section-title" style="text-align:left">Clientes fiÃ©is</div>
        </div>
        <div class="brand-icon">JP</div>
      </div>
      <div class="panel">
        <ul id="listaClientes" class="rank"></ul>
      </div>
    </main>
  </div>
  <script>
    const token = localStorage.getItem('token');
    const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
    const donoId = usuario?.id;
    let padariaId = usuario?.padariaId;
    const auth = token ? { 'Authorization': 'Bearer ' + token } : {};
    async function getPadaria() {
      if (padariaId) return padariaId;
      if (!donoId) return null;
      const r = await fetch('http://localhost:4000/padarias/dono/' + donoId);
      const p = await r.json();
      padariaId = p?.id;
      return padariaId;
    }
    async function carregar(){
      const pid = await getPadaria();
      if(!pid) return;
      const padariaResp = await fetch('http://localhost:4000/padarias/' + pid);
      const padaria = await padariaResp.json();
      document.getElementById('padariaNome').textContent = padaria?.nome || 'Padaria';
      const pedidosResp = await fetch('http://localhost:4000/pedidos/padaria/' + pid, { headers: auth });
      const pedidos = await pedidosResp.json();
      const cont = document.getElementById('listaClientes');
      const mapa = new Map();
      for(const p of pedidos){
        const id = p.cliente?.id;
        if(!id) continue;
        mapa.set(id, { nome: p.cliente?.nome ?? 'Cliente', total: (mapa.get(id)?.total ?? 0) + 1 });
      }
      const lista = [...mapa.values()].sort((a,b)=>b.total-a.total).slice(0,20);
      cont.innerHTML = lista.map((c,i)=> `<li><span>${i+1}. ${c.nome}</span><span>${c.total} pedidos</span></li>`).join('');
    }
    carregar();
    setInterval(carregar, 10000);
  </script>
</body>
</html>
